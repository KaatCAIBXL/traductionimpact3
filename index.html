<!-- index.html: Place in your repo root, acts as a redirect to index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Live translation</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    button { padding: 10px 20px; font-size: 16px; margin: 5px; }
    input[type="checkbox"] { transform: scale(1.5); margin: 10px; }
    p { font-size: 18px; }
  </style>
</head>
<body>
  <h1>Live translation</h1>
  <p>Use your microphone to talk.</p>

  <div>
    <label for="textOnly">
      <input type="checkbox" id="textOnly"> Only text-mode, no voice
    </label>
  </div>



  <label for="sourceLanguage">INPUT language:</label>
  <select id="sourceLanguage">
    <option value="fr">French</option>
  <option value="nl">Dutch</option>
  <option value="en">English (Canada)</option>
  <option value="es">Spanish</option>
  <option value="pt">Portuguese</option>
  <option value="lingala">Lingala</option>
  <option value="fi">Finnish</option>
  <option value="kikongo">Kituba/Kikongo</option>
  <option value="tshiluba">Tshiluba</option>
  <option value="sw">Swahili</option>
  <option value="balou茅">Balou茅</option>
  <option value="dioula">Dioula</option>
  <option value="zh">Chinese (Simplified)</option>
  </select>

  <label for="languageSelect">OUTPUT language:</label>
  <select id="languageSelect">
    <option value="fr">French</option>
  <option value="nl">Dutch</option>
  <option value="en">English (Canada)</option>
  <option value="es">Spanish</option>
  <option value="pt">Portuguese</option>
  <option value="fi">Finnish</option>
  <option value="sw">Swahili</option>
  <option value="sv">Swedish</option>
  <option value="hi">Hindi</option>
  <option value="no">Norwegian</option>
  <option value="de">German</option>
  <option value="ms">Malay</option>
  <option value="am">Amharic</option>
  <option value="id">Indonesian</option>
  <option value="mg">Malagasy</option>
  <option value="ar">Arabic</option>
  <option value="ru">Russian</option>
  <option value="zh">Chinese (Simplified)</option>
  <option value="tr">Turkish</option>
  <option value="pl">Polish</option>
  <option value="ja">Japanese</option>
  </select>

  <br>
  <button id="start">  start recording </button>
  <button id="pause" disabled>革 pause 革</button>
  <button id="stop" disabled>癸 stop 癸</button>

  <!-- Stapelbare tekstcontainers -->
    <h3>Original</h3>
    <div id="orig" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>

  <h3>Recognized</h3>
  <div id="transcript" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>

    <h3>Translation</h3>
    <div id="trans" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>


  <!-- Koppel je JavaScript-bestand -->
  <script src="script.js"></script>
<script>
 let mediaRecorder, bufferChunks = [], isSpeaking = false;
let audioContext, analyser, source, lastSpeechTime = Date.now();
let isPaused = false;
let intervalId;



async function setupAudioDetection(stream) {
  intervalId = setInterval(() => {
  analyser.getByteFrequencyData(dataArray);
  const volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
  isSpeaking = volume > 10;
  if (isSpeaking) lastSpeechTime = Date.now();
}, 200);

  audioContext = new AudioContext();
  source = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  analyser.fftSize = 512;
  source.connect(analyser);

  const dataArray = new Uint8Array(analyser.frequencyBinCount);

}
async function spreekVertaling(text, lang) {
  const formData = new FormData();
  formData.append("text", text);
  formData.append("lang", lang);
  formData.append("speak", "true");

  const response = await fetch("/api/speak", { method: "POST", body: formData });
  const blob = await response.blob();
  const url = URL.createObjectURL(blob);
  const audio = new Audio(url);
  audio.play();
}


document.getElementById("start").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  await setupAudioDetection(stream);

  mediaRecorder = new MediaRecorder(stream, {
  mimeType: "audio/webm;codecs=opus",
  audioBitsPerSecond: 128000
});

  mediaRecorder.start(5000); // elke 5 sec automatisch fragment

  mediaRecorder.ondataavailable = async (event) => {
  const now = Date.now();
  const stilte = now - lastSpeechTime;

  if (stilte < 3000) {
    bufferChunks.push(event.data); // spreker is nog bezig
  } else if (bufferChunks.length > 0) {
    const blob = new Blob(bufferChunks, { type: "audio/webm" });
    bufferChunks = [];

    const formData = new FormData();
    formData.append("audio", blob, "spraak.webm");
    formData.append("from", document.getElementById("sourceLanguage").value);
    formData.append("to", document.getElementById("languageSelect").value);
    formData.append("textOnly", document.getElementById("textOnly").checked ? "true" : "false");

    const unsupportedByDeepL = ["sw", "am", "mg", "lingala", "kikongo", "tshiluba", "balou茅", "dioula"];

    if (unsupportedByDeepL.includes(document.getElementById("languageSelect").value)) {
    alert("This language isn't supported by Deepl and is translated by AI");
    }


    const response = await fetch("/api/translate", { method: "POST", body: formData });
    const data = await response.json();
    document.getElementById("transcript").innerHTML += `<p>${data.original}</p>`;


    document.getElementById("orig").innerHTML += `<p>${data.original}</p>`;
    document.getElementById("trans").innerHTML += `<p>${data.translation}</p>`;
    if (!document.getElementById("textOnly").checked) {
      spreekVertaling(data.translation, document.getElementById("languageSelect").value);
    }
  }
};


      document.getElementById("start").disabled = true;
      document.getElementById("pause").disabled = false;
      document.getElementById("stop").disabled = false;

    } catch (err) {
      alert("Microfoon werkt niet: " + err.message);
      console.error("Microfoonfout:", err);
    }
  };

  document.getElementById("pause").onclick = () => {
    if (!mediaRecorder) return;

    if (!isPaused && mediaRecorder.state === "recording") {
      mediaRecorder.pause();
      isPaused = true;
      document.getElementById("pause").innerText = "讹 continue 讹 ";
    } else if (isPaused && mediaRecorder.state === "paused") {
      mediaRecorder.resume();
      isPaused = false;
      document.getElementById("pause").innerText = "革 pause 革";
    }
  };

  document.getElementById("stop").onclick = () => {
    clearInterval(intervalId);
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
    }

    document.getElementById("start").disabled = false;
    document.getElementById("pause").disabled = true;
    document.getElementById("stop").disabled = true;
    document.getElementById("pause").innerText = "革 pause 革 ";
    isPaused = false;
  };
</script>
</body>
</html>